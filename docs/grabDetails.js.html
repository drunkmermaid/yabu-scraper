<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: grabDetails.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: grabDetails.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Extraí informações sobre o anime (título, quantidade de episódios, etc)
 * @function grabDetails
 * @param {string} url O url para a página do anime
 */

/**
 * @typedef AnimeDetails
 * @property {string} title O título do anime
 * @property {string[]} episodes
 * @property {string} status O estado de publicação do anime
 * @property {number} views A quantidade de visualizações que o anime já teve
 * @property {string} description A descrição/sinopse do anime.
 */

/**
 * @typedef BasicEpisodeInfo
 * @property {string} title O título do episódio
 * @property {string} url A url para acessar o episódio
 * @property {string} thumbnailUrl
 */

import fetch from "node-fetch";
import {
  animeUrl,
  customTag,
  videoDetails,
  animeType,
  animeStatus,
  animeSinopse,
  animeVideos,
  animeVideo,
} from "./rexpressions.js";

const grabBasicInfo = (text) => {
  try {
    const animeInformationData = videoDetails.exec(text);

    if (!animeInformationData || !animeInformationData.length) {
      throw new Error("Could not find data, maybe the page layout has changed");
    }
    const rawData = animeInformationData[0];
    const title = customTag("data-name").exec(rawData)[0];
    const thumbnailUrl = customTag("src").exec(rawData)[0];
    const status = animeStatus.exec(rawData)[0];
    const type = animeType.exec(rawData)[0];
    const description = animeSinopse.exec(rawData)[0];
    return { title, thumbnailUrl, status, type, description };
  } catch (_) {
    throw new Error("Could not find data, maybe the page layout has changed");
  }
};

const getEpisodes = (text) => {
  try {
    const animeEpisodes = animeVideos.exec(text)[0];
    if (!animeEpisodes || !animeEpisodes.length) {
      throw new Error("Could not find data, maybe the page layout has changed");
    }

    const videos = [];
    let found;
    while ((found = animeVideo.exec(animeEpisodes)) !== null) {
      const result = found[0];
      const title = customTag("title").exec(result)[0];
      const url = customTag("href").exec(result)[0];
      const thumbnailUrl = customTag("src").exec(result)[0];
      videos.push({
        title,
        url,
        thumbnailUrl,
      });
    }

    return videos;
  } catch (_) {
    throw new Error("Could not find data, maybe the page layout has changed");
  }
};

export default async function grabDetails(
  url,
  grabInfo = true,
  grabEpisodes = false
) {
  if (!grabInfo &amp;&amp; !grabEpisodes) {
    throw new TypeError("You can't grab nothing");
  }

  const result = {};
  if (!url || (typeof url !== "string") | !animeUrl.test(url)) {
    throw new TypeError("Invalid anime url");
  }
  const websiteData = await fetch(url);
  if (websiteData.url !== url) {
    return result;
  }
  const rawData = await websiteData.text();
  if (grabInfo) {
    Object.assign(result, grabBasicInfo(rawData));
  }
  if (grabEpisodes) {
    Object.assign(result, { episodes: getEpisodes(rawData) });
  }

  return result;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#getLatestUpdated">getLatestUpdated</a></li><li><a href="global.html#grabDetails">grabDetails</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#videoDetails">videoDetails</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Tue Jun 29 2021 19:43:35 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
